{% extends "main/base.html" %}
{% block title %}Мои слоты{% endblock %}

{% block content %}
<div class="slots-page">
    <h1 class="page-title">Мои слоты</h1>
    <div class="slot-form-container">
        <form method="post" class="slot-form">
            {% csrf_token %}
            <div class="form-group">
                <label for="date">Дата:</label>
                <input type="date" id="date" name="date" required>
            </div>
            <div class="form-group">
                <label for="time">Время:</label>
                <input type="time" id="time" name="time" required>
            </div>
           <div class="form-group">
                <label for="service">Услуга:</label>
                <select id="service" name="service" class="styled-select" required>
                    <option value="" disabled selected>Выберите услугу</option>
                    {% for service in services %}
                        <option value="{{ service.id }}">{{ service.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="button">Добавить слот</button>
        </form>
    </div>

    <h2 class="section-title">Список слотов</h2>
    <table class="slots-table">
        <thead>
            <tr>
                <th>Дата</th>
                <th>Время</th>
                <th>Услуга</th>
                <th>Статус</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for slot in slots %}
                <tr>
                    <td>{{ slot.date }}</td>
                    <td>{{ slot.time }}</td>
                    <td>{{ slot.service.name }}</td>
                    <td>{{ slot.get_status_display }}</td>
                    <td>
                        {% if slot.status == "Забронирован" %}
                            {% if slot.camera_active %}
                                <button class="view-camera-btn" data-slot-id="{{ slot.id }}">Активировать камеру</button>
                            {% else %}
                                <button class="view-camera-btn" data-slot-id="{{ slot.id }}">Активировать камеру</button>
                            {% endif %}
                        {% else %}
                            <span>Нет действий</span>
                        {% endif %}
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="4" class="no-slots">Слотов пока нет.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div id="cameraModal" class="modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2>Камера</h2>
        <div id="camera-stream">
            <video autoplay></video>
        </div>
        <button id="completeServiceButton" class="button">Завершить выполнение услуги</button>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("cameraModal");
    const closeModal = document.querySelector(".close-modal");
    const videoElement = document.querySelector("#camera-stream video");

    document.querySelectorAll(".view-camera-btn").forEach((button) => {
        button.addEventListener("click", () => {
            const slotId = button.dataset.slotId;

            fetch(`/toggle_camera/${slotId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json",
                },
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success && data.camera_active) {
                        modal.style.display = "block";

                        // Подключение камеры через WebRTC
                        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                            navigator.mediaDevices
                                .getUserMedia({ video: true })
                                .then((stream) => {
                                    videoElement.srcObject = stream;
                                    videoElement.play();
                                })
                                .catch((err) => {
                                    console.error("Ошибка при подключении к камере:", err);
                                    alert("Не удалось подключиться к камере.");
                                });
                        } else {
                            alert("Камера не поддерживается в этом браузере.");
                        }
                    } else if (!data.camera_active) {
                        alert("Камера была отключена.");
                    } else {
                        alert("Не удалось изменить состояние камеры.");
                    }
                })
                .catch((error) => console.error("Ошибка:", error));
        });
    });

    // Закрытие модального окна
    closeModal.addEventListener("click", () => {
        modal.style.display = "none";
        const stream = videoElement.srcObject;
        if (stream) {
            const tracks = stream.getTracks();
            tracks.forEach((track) => track.stop());
        }
        videoElement.srcObject = null;
    });

    window.addEventListener("click", (event) => {
        if (event.target === modal) {
            modal.style.display = "none";
            const stream = videoElement.srcObject;
            if (stream) {
                const tracks = stream.getTracks();
                tracks.forEach((track) => track.stop());
            }
            videoElement.srcObject = null;
        }
    });
});

</script>
<style>
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.7);
    }

    .modal-content {
        background-color: #fff;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 60%;
        text-align: center;
    }

    .close-modal {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .close-modal:hover,
    .close-modal:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }

    #camera-stream video {
        width: 100%;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    }
</style>
{% endblock %}
